<!DOCTYPE html>
<html>
<head>
    <title>SOSNow Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #mapid { position: absolute; top: 0; bottom: 0; left: 0; right: 300px; }
        #alert-sidebar { position: absolute; top: 0; bottom: 0; right: 0; width: 300px; background-color: #f8f8f8; overflow-y: auto; padding: 10px; box-shadow: -2px 0 5px rgba(0,0,0,0.1); }
        .alert-item { background-color: #fff; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .alert-item h4 { margin-top: 0; margin-bottom: 5px; color: #333; }
        .alert-item p { margin: 0; font-size: 0.9em; color: #666; }
        .alert-item button { background-color: #4CAF50; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; margin-top: 10px; float: right; }
        .alert-item button:hover { background-color: #45a049; }
    </style>
</head>
<body>
    <div id="mapid"></div>
    <div id="alert-sidebar">
        <h3>Active Alerts</h3>
        <div id="alerts-list"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        var mymap = L.map('mapid').setView([0, 0], 2); // Default view, will be updated

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(mymap);

        var markers = {}; // To store markers by their alertId
        var alertsList = document.getElementById('alerts-list');

        var socket = io();

        socket.on('connect', function() {
            console.log('Connected to WebSocket');
        });

        // Handle initial alerts when connecting
        socket.on('current_alerts', function(alerts) {
            console.log('Received current alerts:', alerts);
            alerts.forEach(addAlertToMapAndList);
        });

        socket.on('mqtt_message', function(data) {
            console.log('Received MQTT message:', data);
            addAlertToMapAndList(data);
        });

        socket.on('remove_alert', function(alertId) {
            console.log('Removing alert:', alertId);
            if (markers[alertId]) {
                mymap.removeLayer(markers[alertId]);
                delete markers[alertId];
            }
            var alertElement = document.getElementById('alert-' + alertId);
            if (alertElement) {
                alertElement.remove();
            }
        });

        function addAlertToMapAndList(data) {
            var payload = JSON.parse(data.payload);
            var type = payload.type || 'unknown';
            var lat = payload.latitude;
            var lon = payload.longitude;
            var userName = data.userName || 'N/A';
            var userNumber = data.userNumber || 'N/A';
            var alertId = data.alertId; // Use the alertId from the server

            if (typeof lat === 'number' && typeof lon === 'number' && alertId) {
                var popupContent = '<b>' + type.replace(/_/g, ' ').toUpperCase() + '</b><br>' +
                                   'Name: ' + userName + '<br>' +
                                   'Number: ' + userNumber + '<br>' +
                                   'Latitude: ' + lat + '<br>' +
                                   'Longitude: ' + lon;

                var marker = L.marker([lat, lon]).addTo(mymap)
                    .bindPopup(popupContent);
                
                markers[alertId] = marker;
                mymap.setView([lat, lon], 15); // Center map on new event

                // Add to alerts list
                var alertItem = document.createElement('div');
                alertItem.id = 'alert-' + alertId;
                alertItem.className = 'alert-item';
                alertItem.innerHTML = 
                    '<h4>' + type.replace(/_/g, ' ').toUpperCase() + '</h4>' +
                    '<p>Name: ' + userName + '</p>' +
                    '<p>Number: ' + userNumber + '</p>' +
                    '<p>Lat: ' + lat.toFixed(4) + ', Lon: ' + lon.toFixed(4) + '</p>' +
                    '<button onclick="acknowledgeAlert(\'' + alertId + '\')">Acknowledge</button>';
                alertsList.prepend(alertItem); // Add to top of list
            }
        }

        function acknowledgeAlert(alertId) {
            console.log('Acknowledging alert:', alertId);
            socket.emit('acknowledge_alert', alertId);
        }

        socket.on('disconnect', function() {
            console.log('Disconnected from WebSocket');
        });
    </script>
</body>
</html>